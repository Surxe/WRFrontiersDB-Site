---
import {
  type PilotClass,
  type PilotPersonality,
  type PilotType,
  type Pilot,
  type PilotTalent,
  type PilotTalentType,
} from '../../../types/pilot';
import { type Rarity } from '../../../types/rarity';
import Icon from '../../../components/Icon.astro';
import LocalizedText from '../../../components/LocalizedText.astro';
import VersionList from '../../../components/VersionList.astro';
import ObjectPageScripts from '../../../components/ObjectPageScripts.astro';
import ParseObjectPage from '../../../components/ParseObjectPage.astro';
import {
  generateObjectStaticPaths,
  getParseObjects,
  getParseObject,
  getVersionsData,
} from '../../../utils/parse_object';
import ObjRef from '../../../components/obj_ref/ObjRef.astro';
import { getDefaultString } from '../../../utils/localization';
import { getStatValueChoices } from '../../../utils/stat';
import type { ModuleStat } from '../../../types/module';


export async function getStaticPaths() {
  return await generateObjectStaticPaths('Objects/Pilot.json');
}

const { id, version } = Astro.params;
const { objectVersions } = Astro.props;

const pilot = getParseObject<Pilot>(id, version, 'Objects/Pilot.json');
const pilotTalents = getParseObjects<PilotTalent>(
  'Objects/PilotTalent.json',
  version
);
const pilotTalentTypes = getParseObjects<PilotTalentType>(
  'Objects/PilotTalentType.json',
  version
);
const pilotTypes = getParseObjects<PilotType>(
  'Objects/PilotType.json',
  version
);
// Load ModuleStats for stat replacements
const moduleStats = getParseObjects<ModuleStat>(
  'Objects/ModuleStat.json',
  version
);

const rarity = getParseObject<Rarity>(
  pilotTypes[pilot.pilot_type_id].rarity_id,
  version,
  'Objects/Rarity.json'
);
const pilotClass = getParseObject<PilotClass>(
  pilot.pilot_class_id,
  version,
  'Objects/PilotClass.json'
);
const pilotPersonality = getParseObject<PilotPersonality>(
  pilot.personality_id,
  version,
  'Objects/PilotPersonality.json'
);

// Load version metadata
const { versions, versionInfo } = getVersionsData(version);

// Extract English text as fallback
const defaultName = getDefaultString(pilot.first_name) || pilot.id;
---

<ParseObjectPage>
  <LocalizedText
    id="pilot-name-title"
    tag="title"
    localizationKey={pilot.first_name}
    slot="head"
  />
  <p>Back to <a href="/pilots">Pilots</a></p>
  <p>
    <LocalizedText
      id="pilot-first-name"
      tag="span"
      localizationKey={pilot.first_name}
    />
    {' '}
    {
      pilot.second_name && (
        <LocalizedText
          id="pilot-second-name"
          tag="span"
          localizationKey={pilot.second_name}
        />
      )
    }
  </p>

  <LocalizedText id="pilot-bio" tag="p" localizationKey={pilot.bio} />

  <Icon iconPath={pilot.image_path} altText={`${defaultName} portrait`} />

  <p id="pilot-sell-price-currency">
    Sell Price Currency: {pilot.sell_price.currency_id}
  </p>
  <p id="pilot-sell-price-amount">
    Sell Price Amount: {pilot.sell_price.amount}
  </p>

  <h3>Levels</h3>
  <table>
    <thead>
      <tr>
        <th>Level</th>
        <th>Talent Type</th>
        <th>Talents</th>
      </tr>
    </thead>
    <tbody>
      {
        pilot.levels?.map((level, index) => (
          <tr>
            <td>{index + 1}</td>
            <td>
              <ObjRef
                obj={pilotTalentTypes[level.talent_type_id]}
                version={version}
              />
            </td>
            <td>
              <div>
                {level.talents?.map((talent_id) => (
                  <span>
                    <ObjRef
                      obj={pilotTalents[talent_id]}
                      version={version}
                      useOnHover={true}
                      onHoverStatChoices={getStatValueChoices(pilotTalents[talent_id].stats, moduleStats)}
                    />
                  </span>
                ))}
              </div>
            </td>
          </tr>
        ))
      }
    </tbody>
  </table>

  <!-- Hyperlinks to the referenced ids pilot_type_id, pilot_class_id, personality_id -->
  <p>
    Rarity
    <ObjRef obj={rarity} version={version} useHref={false} />
  </p>
  <p>
    Pilot Class
    <ObjRef obj={pilotClass} version={version} />
  </p>
  <p>
    Pilot Personality
    <ObjRef obj={pilotPersonality} version={version} />
  </p>
  <p>faction_id placeholder</p>

  <p>Version: {versionInfo?.title || version} ({version})</p>
  <p>Language: <span id="current-lang">en</span></p>

  <VersionList
    parseObjectUrl="pilot_types"
    id={id}
    myVersions={objectVersions}
    versionsData={versions}
  />

  <ObjectPageScripts version={version} objectData={pilot} />
</ParseObjectPage>
