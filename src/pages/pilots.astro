---
import BackToHome from '../components/BackToHome.astro';
import ParseObjectListPage from '../components/ParseObjectListPage.astro';
import { getAllVersions, getParseObjects } from '../utils/parse_object';
import { prepareObjectList, groupBy, sortGroups } from '../utils/list_helpers';
import type { Pilot, PilotType, PilotTalent } from '../types/pilot';
import LocalizedText from '../components/LocalizedText.astro';
import Icon from '../components/Icon.astro';

const { versions, latestVersion } = getAllVersions();

// Load pilots, pilot types, and pilot talents
const pilots = getParseObjects<Pilot>("Objects/Pilot.json", latestVersion);
const pilotTypes = getParseObjects<PilotType>("Objects/PilotType.json", latestVersion);
const pilotTalents = getParseObjects<PilotTalent>("Objects/PilotTalent.json", latestVersion);

// Prepare and filter pilots
const entries = prepareObjectList(pilots, { prodReadyOnly: false });

// Group by pilot type
const grouped = groupBy(entries, ([_, pilot]) => pilot.pilot_type_id);

// Define explicit sort order for pilot types
const pilotTypeOrder: Record<string, number> = {
  'DA_PilotType_Legendary.0': 1,
  'DA_PilotType_Common.0': 2,
};

// Sort groups with explicit order: Legendary before Common
const sortedGroups = sortGroups(grouped, (a, b) => {
  const orderA = pilotTypeOrder[a] || 999;
  const orderB = pilotTypeOrder[b] || 999;
  return orderA - orderB;
});
---

<ParseObjectListPage title="Pilots">
    <BackToHome />
    <h1>Pilots</h1>
    
    <p>Showing pilots from latest version: {versions[latestVersion].title} ({latestVersion})</p>

    {sortedGroups.map(([pilotTypeId, pilotEntries]) => (
      <section>
        <h2>
          <LocalizedText
            tag="span"
            localizationKey={pilotTypes[pilotTypeId].name}
          />
        </h2>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Icon</th>
              <th>Level 1</th>
              <th>Level 2</th>
              <th>Level 3</th>
              <th>Level 4</th>
              <th>Level 5</th>
            </tr>
          </thead>
          <tbody>
            {pilotEntries.map(([id, pilot]) => {
              // Calculate max talents across all levels for this pilot
              const maxTalents = Math.max(
                ...pilot.levels.map(level => level?.talents?.length || 0)
              );
              
              return Array.from({ length: Math.max(1, maxTalents) }).map((_, talentIndex) => (
                <tr>
                  {talentIndex === 0 && (
                    <>
                      <td rowspan={maxTalents}>
                        <a href={`/WRFrontiersDB-Site/pilots/${id}/${latestVersion}`}>
                          <LocalizedText
                            tag="span"
                            localizationKey={pilot.first_name}
                          />
                        </a>
                      </td>
                      <td rowspan={maxTalents}>
                        <Icon 
                          iconPath={pilot.image_path}
                          altText={`${pilot.first_name.en} icon`}
                          size={48}
                        />
                      </td>
                    </>
                  )}
                  {[0, 1, 2, 3, 4].map(levelIndex => {
                    const talentId = pilot.levels[levelIndex]?.talents?.[talentIndex];
                    return (
                      <td>
                        {talentId && pilotTalents[talentId] && (
                          <a href={`/WRFrontiersDB-Site/pilot_talents/${talentId}/${latestVersion}`}>
                            <Icon 
                              iconPath={pilotTalents[talentId].image_path}
                              altText={`${pilotTalents[talentId].name.en} icon`}
                              size={24}
                            />
                            <LocalizedText
                              tag="span"
                              localizationKey={pilotTalents[talentId].name}
                            />
                          </a>
                        )}
                      </td>
                    );
                  })}
                </tr>
              ));
            })}
          </tbody>
        </table>
      </section>
    ))}
</ParseObjectListPage>