---
import BackToHome from '../components/BackToHome.astro';
import ParseObjectListPage from '../components/ParseObjectListPage.astro';
import { getAllVersions, getParseObjects } from '../utils/parse_object';
import { prepareObjectList, groupBy, sortGroups } from '../utils/list_helpers';
import type { Pilot, PilotType, PilotTalent, PilotTalentType } from '../types/pilot';
import LocalizedText from '../components/LocalizedText.astro';
import Icon from '../components/Icon.astro';
import PageRef from '../components/PageRef.astro';
import LevelTableData from '../components/pilot/LevelTableData.astro';

const { versions, latestVersion } = getAllVersions();

// Load pilots, pilot types, and pilot talents
const pilots = getParseObjects<Pilot>("Objects/Pilot.json", latestVersion);
const pilotTypes = getParseObjects<PilotType>("Objects/PilotType.json", latestVersion);
const pilotTalents = getParseObjects<PilotTalent>("Objects/PilotTalent.json", latestVersion);
const pilotTalentTypes = getParseObjects<PilotTalentType>("Objects/PilotTalentType.json", latestVersion);

// Prepare and filter pilots
const entries = prepareObjectList(pilots, { prodReadyOnly: false });

// Group by pilot type
const grouped = groupBy(entries, ([_, pilot]) => pilot.pilot_type_id);

// Define explicit sort order for pilot types
const pilotTypeOrder: Record<string, number> = {
  'DA_PilotType_Legendary.0': 1,
  'DA_PilotType_Common.0': 2,
};

// Sort groups with explicit order: Legendary before Common
const sortedGroups = sortGroups(grouped, (a, b) => {
  const orderA = pilotTypeOrder[a] || 999;
  const orderB = pilotTypeOrder[b] || 999;
  return orderA - orderB;
});

const levelOneTalentTypeId = 'DA_TalentType_General.0';
const levelFiveTalentTypeId = 'DA_TalentType_Ult.0';
---

<ParseObjectListPage title="Pilots">
    <BackToHome />
    <h1>Pilots</h1>
    
    <p>Showing pilots from latest version: {versions[latestVersion].title} ({latestVersion})</p>

    <!-- 
    Create table. Levels 1 through 4 may have multiple talents in them, so 
    the other columns have rowspan to center them within their group of rows
    -->
    {sortedGroups.map(([pilotTypeId, pilotEntries]) => (
      <section>
        <h2>
          <LocalizedText
            tag="span"
            localizationKey={pilotTypes[pilotTypeId].name}
          />
        </h2>
        <table>
          <thead>
            <tr>
              <th>Pilot Name</th>
              <th>
                Level 1
                <PageRef 
                  obj={pilotTalentTypes[levelOneTalentTypeId]} 
                  version={latestVersion}
                />
              </th>
              <th></th>
              <th>Level 2</th>
              <th></th>
              <th>Level 3</th>
              <th></th>
              <th>Level 4</th>
              <th>
                Level 5
                <PageRef 
                  obj={pilotTalentTypes[levelFiveTalentTypeId]} 
                  version={latestVersion}
                />
              </th>
            </tr>
          </thead>
          <tbody>
            {pilotEntries.map(([id, pilot]) => {
              // Calculate max talents across all levels for this pilot
              const maxTalents = Math.max(
                ...pilot.levels.map(level => level?.talents?.length || 0)
              );
              
              return Array.from({ length: Math.max(1, maxTalents) }).map((_, talentIndex) => (
                <tr>
                  {talentIndex === 0 && (
                    <>
                      <td rowspan={maxTalents}>
                        <a href={`/WRFrontiersDB-Site/pilots/${id}/${latestVersion}`}>
                          <PageRef 
                            obj={pilot} 
                            version={latestVersion}
                            iconSize={48}
                          />
                        </a>
                      </td>
                    </>
                  )}
                  {/* Level 1 */}
                  {(() => {
                    const talentId = pilot.levels[0]?.talents?.[talentIndex];
                    return (
                      <td>
                        {talentId && pilotTalents[talentId] && (
                          <PageRef 
                            obj={pilotTalents[talentId]} 
                            version={latestVersion}
                          />
                        )}
                      </td>
                    );
                  })()}
                  {/* Level 2 */}
                  <LevelTableData 
                    levelIndex={1}
                    level={pilot.levels[1]}
                    talentIndex={talentIndex}
                    maxTalents={maxTalents}
                    pilotTalents={pilotTalents}
                    pilotTalentTypes={pilotTalentTypes}
                    version={latestVersion}
                  />
                  {/* Level 3 */}
                  <LevelTableData 
                    levelIndex={2}
                    level={pilot.levels[2]}
                    talentIndex={talentIndex}
                    maxTalents={maxTalents}
                    pilotTalents={pilotTalents}
                    pilotTalentTypes={pilotTalentTypes}
                    version={latestVersion}
                  />
                  {/* Level 4 */}
                  <LevelTableData 
                    levelIndex={3}
                    level={pilot.levels[3]}
                    talentIndex={talentIndex}
                    maxTalents={maxTalents}
                    pilotTalents={pilotTalents}
                    pilotTalentTypes={pilotTalentTypes}
                    version={latestVersion}
                  />
                  {/* Level 5 */}
                  {talentIndex === 0 && (
                    <td rowspan={maxTalents}>
                      {pilot.levels[4]?.talents?.[0] && pilotTalents[pilot.levels[4].talents[0]] && (
                        <PageRef 
                          obj={pilotTalents[pilot.levels[4].talents[0]]} 
                          version={latestVersion}
                        />
                      )}
                    </td>
                  )}
                </tr>
              ));
            })}
          </tbody>
        </table>
      </section>
    ))}
</ParseObjectListPage>