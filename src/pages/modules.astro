---
import BackToHome from '../components/BackToHome.astro';
import ParseObjectListPage from '../components/ParseObjectListPage.astro';
import { getAllVersions, getParseObjects } from '../utils/parse_object';
import { prepareObjectList, groupBy, sortGroups } from '../utils/list';
import type { Module } from '../types/module';
import PageRef from '../components/PageRef.astro';

const { versions, latestVersion } = getAllVersions();

// Load all modules
const modules = getParseObjects<Module>('Objects/Module.json', latestVersion);

// Prepare and filter modules
const entries = prepareObjectList(modules, { prodReadyOnly: true });

// Group by module_type_id
const grouped = groupBy(
  entries,
  ([_, module]) => module.module_type_id || 'Unknown'
);

// Sort groups alphabetically
const sortedGroups = sortGroups(grouped);
---

<ParseObjectListPage title="Modules">
  <BackToHome />
  <h1>Modules</h1>

  <p>
    Showing modules from latest version: {versions[latestVersion].title} ({
      latestVersion
    })
  </p>

  {
    sortedGroups.map(([moduleTypeId, moduleEntries]) => (
      <section>
        <h2>{moduleTypeId}</h2>
        <ul>
          {moduleEntries.map(([_id, module]) => (
            <li>
              <PageRef obj={module} version={latestVersion} />
            </li>
          ))}
        </ul>
      </section>
    ))
  }
</ParseObjectListPage>
