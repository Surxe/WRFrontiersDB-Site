---
import BackToHome from '../components/BackToHome.astro';
import ParseObjectListPage from '../components/ParseObjectListPage.astro';
import { getAllVersions, getParseObjects } from '../utils/parse_object';
import { prepareObjectList, groupBy, sortGroups } from '../utils/list';
import { enrichPilotTalents } from '../utils/pilot';
import { getStatValueChoices } from '../utils/stat';
import type { PilotTalent, PilotTalentType, Pilot } from '../types/pilot';
import type { ModuleStat } from '../types/module';
import StatEmbedLocalizedText from '../components/StatEmbedLocalizedText.astro';
import ObjRef from '../components/ObjRef.astro';

const { versions, latestVersion } = getAllVersions();

// Load all data
const pilotTalents = getParseObjects<PilotTalent>(
  'Objects/PilotTalent.json',
  latestVersion
);
const pilotTalentTypes = getParseObjects<PilotTalentType>(
  'Objects/PilotTalentType.json',
  latestVersion
);
const pilots = getParseObjects<Pilot>('Objects/Pilot.json', latestVersion);

// Enrich talents with type and level information
const enrichedTalents = enrichPilotTalents(pilotTalents, pilots);

// Load ModuleStats for stat replacements
const moduleStats = getParseObjects<ModuleStat>(
  'Objects/ModuleStat.json',
  latestVersion
);

// Prepare and filter
const entries = prepareObjectList(enrichedTalents, { prodReadyOnly: false });

// Group by level
const grouped = groupBy(entries, ([_, talent]) =>
  (talent.level ?? -1).toString()
);

// Sort groups numerically
const sortedGroups = sortGroups(grouped, (a, b) => Number(a) - Number(b));
---

<ParseObjectListPage title="Pilot Talents" version={latestVersion}>
  <BackToHome />
  <h1>Pilot Talents</h1>

  <p>
    Showing pilot talents from latest version: {versions[latestVersion].title} ({
      latestVersion
    })
  </p>

  {
    sortedGroups.map(([levelNum, pilotTalentEntries]) => (
      <section>
        <h2>Level {levelNum}</h2>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Description</th>
              <th>Talent Type</th>
            </tr>
          </thead>
          <tbody>
            {pilotTalentEntries.map(([_id, talent]) => (
              <tr>
                <td>
                  <ObjRef obj={talent} version={latestVersion} />
                </td>
                <td>
                  <StatEmbedLocalizedText
                    tag="span"
                    localizationKey={talent.description}
                    statValueChoices={getStatValueChoices(
                      talent.stats || [],
                      moduleStats
                    )}
                  />
                </td>
                <td>
                  {talent.talent_type_id && (
                    <ObjRef
                      obj={pilotTalentTypes[talent.talent_type_id]}
                      version={latestVersion}
                    />
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </section>
    ))
  }
</ParseObjectListPage>
