---
import type { LocalizationKey } from '../types/localization';
import type { ModuleStat } from '../types/module';
import { getDefaultString } from '../utils/localization';

export interface StatValueChoices {
  [stat_id: string]: {
    choices: {
      [choiceIndex: number]: number;
    };
    statObject: ModuleStat;
  };
}

export interface Props {
  id?: string;
  tag: string;
  localizationKey: LocalizationKey;
  statValueChoices: StatValueChoices;
}

const { id, tag, localizationKey, statValueChoices } = Astro.props;
const Tag = tag as any;

// Build the choice map using short_key from statObject
// Format: { shortKey: { 0: value, 1: value, ... } }
const choiceMap: Record<string, Record<number, number>> = {};
for (const [_, data] of Object.entries(statValueChoices)) {
  const shortKey = data.statObject.short_key;
  choiceMap[shortKey] = data.choices;
}

const namespace = localizationKey.TableNamespace;
const key = localizationKey.Key;
const invariantString = localizationKey.InvariantString;
const defaultText = getDefaultString(localizationKey);
---

<!--
Creates an html element with localization data attributes and stat replacement data
-->{
  invariantString ? (
    <Tag id={id}>{invariantString}</Tag>
  ) : (
    <Tag
      id={id}
      data-loc-key={key}
      data-loc-namespace={namespace}
      data-stat-value-choices={JSON.stringify(choiceMap)}
      data-current-choice="0"
    >
      {defaultText}
    </Tag>
  )
}
