---
import ObjRef from '../obj_ref/ObjRef.astro';
import type { PilotTalent } from '../../types/pilot';
import type { ModuleStat } from '../../types/module';
import { getParseObjects } from '../../utils/parse_object';
import { getStatValueChoices } from '../../utils/stat';
import StatEmbedLocalizedText from '../StatEmbedLocalizedText.astro';

interface Props {
  levelIndex: number; // 0 for level 1, 1 for level 2, 2 for level 3, 3 for level 4, 4 for level 5
  level?: {
    talents?: string[];
    talent_type_id?: string;
  };
  talentIndex: number;
  maxTalents: number;
  pilotTalents: Record<string, PilotTalent>;
  version: string;
  fullOrOnHover?: 'full' | 'onHover';
}

/*
Create table data cells that look like this for the respective levels:
Level 1-4:
Talent1
Talent2
Talent3

Level 5: 
Talent1 (rowspan=maxTalents)

To summarize: Levels 1-4 have 3 talents, level 5 has 1 talent. 
*/

const { levelIndex, level, talentIndex, maxTalents, pilotTalents, version, fullOrOnHover='onHover' } =
  Astro.props;

// Load ModuleStats for stat replacements
const moduleStats = getParseObjects<ModuleStat>(
  'Objects/ModuleStat.json',
  version
);

// For level 5, always use the first talent; for others, use the current talentIndex
// because level 5 only has one talent slot
const getTalentData = (levelIdx: number, talentIdx: number) => {
  const talentId =
    levelIdx === 4 ? level?.talents?.[0] : level?.talents?.[talentIdx];
  const talent = talentId ? pilotTalents[talentId] : undefined;
  const statValueChoices = talent
    ? getStatValueChoices(talent.stats, moduleStats)
    : undefined;
  return { talent, statValueChoices };
};
---

{/* Talent column */}
{/* For level 5, use rowspan and only render on first talent row */}
{/* For levels 1 and 2-4, render for each talent index */}
{
  levelIndex === 4
    ? talentIndex === 0 &&
      (() => {
        const { talent, statValueChoices } = getTalentData(
          levelIndex,
          talentIndex
        );
        return (
          <td rowspan={maxTalents}>
            {talent && (
              <ObjRef
                obj={talent}
                version={version}
                useOnHover={fullOrOnHover === 'onHover'}
                onHoverStatChoices={statValueChoices ? statValueChoices : undefined}
              />
              <StatEmbedLocalizedText
                tag="span"
                localizationKey={talent.description}
                statValueChoices={statValueChoices}
              />
            )}
          </td>
        );
      })()
    : (() => {
        const { talent, statValueChoices } = getTalentData(
          levelIndex,
          talentIndex
        );
        return (
          <td>
            {talent && (
              <ObjRef
                obj={talent}
                version={version}
                useOnHover={fullOrOnHover === 'onHover'}
                onHoverStatChoices={statValueChoices ? statValueChoices : undefined}
              />
              <StatEmbedLocalizedText
                tag="span"
                localizationKey={talent.description}
                statValueChoices={statValueChoices}
              />
            )}
          </td>
        );
      })()
}
